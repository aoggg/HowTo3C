<!DOCTYPE html>
<html>
<head>
    <title>HowTo3C | 基於AI的3C使用助手</title>
    <meta charset="UTF-8">
    <meta name="description" content="HowTo3C 是一款基於AI的3C使用助手，免費協助排解電腦、手機、平板等電子產品使用過程中的疑難雜症，由國內大學生自主研發，提供簡單便利的服務。">
    <style>
header {
    background-color: #f0f0f0; /* 背景顏色 */
    padding: 10px; /* 內邊距 */
    position: fixed; /* 固定在頁面頂部 */
    top: 0;
    left: 0;
    z-index: 100; /* 確保在其他元素之上 */
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); /* 陰影效果 */
}

.header-left {
    display: flex; /* 使用 Flexbox 佈局 */
    align-items: center; /* 垂直置中 */
}

.website-name {
    font-size: 20px; /* 字體大小 */
    font-weight: bold; /* 字體粗細 */
    margin-right: 10px; /* 右邊間距 */
}

.test-button {
    background-color: #ff42aa; /* 背景顏色 */
    color: white; /* 文字顏色 */
    padding: 8px 16px; /* 內邊距 */
    border: none; /* 移除邊框 */
    border-radius: 20px; /* 圓角 */
    cursor: pointer; /* 滑鼠游標樣式 */
    transition: background-color 0.3s ease; /* 過渡效果 */
    text-decoration: none;
}

.test-button:hover {
    background-color: #d83890; /* Hover 時的背景顏色 */
}
body {
    font-family: sans-serif;
    margin: 0;
    display: flex;
    flex-direction: column;
    min-height: 100vh;
    background-color: #f5f5f5;
    font-size: 16px; /* 設定基本字體大小 */
}

#chat-container {
    width: 90%;
    max-width: 500px; /* 在較大螢幕上限制最大寬度 */
    margin: 20px auto;
    border: 1px solid #ddd;
    padding: 10px;
    overflow-y: auto;
    flex-grow: 1;
    border-radius: 8px;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    background-color: white;
    padding-bottom: 70px; /* 根據輸入欄的高度調整，略微增加 */
    box-sizing: border-box;
}

.message {
    margin-bottom: 10px;
    padding: 10px;
    border-radius: 10px;
    clear: both;
    word-wrap: break-word;
    font-size: 1rem; /* 使用 rem 單位，更容易縮放 */
    line-height: 1.4; /* 設定行高，增加可讀性 */
}

.user {
    background-color: #dcf8c6;
    float: right;
}

.bot {
    background-color: #e0f2f7;
    float: left;
}

#input-area {
    width: 100%;
    padding: 10px;
    background-color: #eee;
    box-sizing: border-box;
    position: fixed;
    bottom: 0;
    left: 0;
    display: flex;
    justify-content: center;
}

#message-input {
    width: 80%;
    padding: 8px;
    border: 1px solid #ccc;
    border-radius: 5px;
    box-sizing: border-box;
    flex-grow: 1;
    font-size: 1rem; /* 輸入框字體大小 */
}

#send-button, #screenshotButton {
    margin-left: 10px;
    padding: 8px 15px;
    background-color: #4CAF50;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 1rem; /* 按鈕字體大小 */
}

#send-button:hover, #screenshotButton:hover {
    background-color: #3E8E41;
    color: white;
}

#pipButton {
    margin-left: 10px;
    padding: 8px 15px;
    background-color: #c96865;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 1rem; /* 按鈕字體大小 */
}

#pipButton:hover {
    background-color: #A63E3A;
    color: white;
}

#chat-container img {
    max-width: 90%;
    height: auto;
    display: block;
    margin: 5px auto;
    object-fit: cover; /* 讓圖片填滿容器，並保持圖片的長寬比 */
    transition: transform 0s ease; /* 加入過渡效果，使放大縮小更平滑 */
}

#chat-container img.fullscreen {
    position: fixed;
    top: 0;
    left: 50%;
    width: 90vw; /* 寬度佔滿 viewport */
    height: 90vh; /* 高度佔滿 viewport */
    object-fit: contain; /* 確保完整顯示圖片，不會被裁切 */
    z-index: 9999; /* 讓圖片在最上層 */
    background-color: rgba(0, 0, 0, 0.5); /* 加上背景遮罩，使圖片更突出 */
    transform: translateX(-50%); /* 避免在全螢幕模式下再次縮放 */
}
    </style>
</head>
<body>
    <header>
        <div class="header-left">
            <span class="website-name">HowTo3C</span>
            <a class="test-button" href="about">關於</a>
            <a class="test-button" href="nothing">Secret</a>
        </div>
    </header>
    <div id="chat-container">
    </div>
    <div id="input-area">
        <input type="text" id="message-input" placeholder="輸入問題...">
        <div id = "screenshotContainer">
            <button id="screenshotButton">截圖</button>
        </div>
        <div id = "sendContainer">
            <button id="send-button">送出</button>
        </div>
        <div id = "pipContainer">
            <button id="pipButton">縮小</button>
        </div>
    </div>
    <video id="screenVideo" autoplay playsinline style="display: none;"></video>
    <canvas id="offscreenCanvas" style="display: none;"></canvas>

    <script>
        const chatContainer = document.getElementById('chat-container');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const screenshotButton = document.getElementById('screenshotButton');
        const pipButton = document.getElementById('pipButton');
        const video = document.getElementById('screenVideo');
        const offscreenCanvas = document.getElementById('offscreenCanvas');
        const offscreenCtx = offscreenCanvas.getContext('2d');
        let stream; // 宣告 stream 變數在全域 scope
        let questionNow="";

        async function startScreenCapture() {
            try {
                stream = await navigator.mediaDevices.getDisplayMedia({ video: true });
                video.srcObject = stream;

                video.onloadedmetadata = () => {
                    offscreenCanvas.width = video.videoWidth;
                    offscreenCanvas.height = video.videoHeight;
                    drawOffscreen();
                };
            } catch (err) {
                console.error("Error accessing media devices.", err);
            }
        }
        startScreenCapture();

        function drawOffscreen() {
            if (video.videoWidth > 0 && video.videoHeight > 0) {
                offscreenCtx.drawImage(video, 0, 0, video.videoWidth, video.videoHeight);
            }
            requestAnimationFrame(drawOffscreen);
        }

        async function captureScreen() {
            return new Promise((resolve) => {
                const img = offscreenCanvas.toDataURL('image/png');
                resolve(img);
            });
        }
        async function updateScreenshot(){
            const screenshot = await captureScreen();
            if(chatContainer.children.length!=0&&chatContainer.lastChild.classList.contains('user')&&chatContainer.lastChild.tagName=='IMG'){
                chatContainer.lastChild.src = screenshot;
            }else{
                appendImage('user',screenshot);
            }
        }
        screenshotButton.addEventListener('click', updateScreenshot);

        function drawDot(ctx, x, y) {
          ctx.beginPath();
          console.log([x, y]);
          ctx.arc(x, y, 10, 0, 2 * Math.PI);
          ctx.fillStyle = 'red';
          ctx.fill();
          ctx.closePath();
        }

        async function callAPI(question){
          const imageElement=chatContainer.lastChild;
          const canvas = document.createElement('canvas');
          canvas.width = imageElement.naturalWidth;
          canvas.height = imageElement.naturalHeight;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(imageElement, 0, 0);
          try {
              const blob = await new Promise((resolve, reject) => {
                  canvas.toBlob(resolve, 'image/png');
              });
            
              if (!blob) {
                  throw new Error("無法取得圖片 Blob 資料。");
              }
            
              const formData = new FormData();
              formData.append('image', blob, 'image.png');
              formData.append('question', question);
            
              const response = await fetch('https://howto.howto3c.xyz', {
                  method: 'POST',
                  body: formData,
              });
            
              if (!response.ok) {
                  const errorData = await response.json();
                  throw new Error(`HTTP 錯誤! 狀態碼: ${response.status} 訊息: ${errorData.error || response.statusText}`); // 包含狀態文字
              }
            
              const data = await response.json();
              console.log(data);
              if(data['content']['operation']=='click'||data['content']['operation']=='write'){
                drawDot(ctx,data['content']['x']*canvas.width,data['content']['y']*canvas.height);
                const dataURL = canvas.toDataURL('image/png');
                return [dataURL,data['content']['thought'],data['content']['operation']];
              }else{
                return [null,data['content']['thought'],data['content']['operation']];
              }
          } catch (error) {
              console.error('請求 Cloud Function 失敗:', error);
              alert('請求失敗：' + error.message);
              return null; // 發生錯誤時回傳 null
          }
        }
        async function send(){
            const userMessage = messageInput.value;
            if (userMessage.trim() !== ""||questionNow!=="") { // 檢查是否為空訊息
                if(userMessage.trim()!=="")questionNow=userMessage.trim();
                if(chatContainer.children.length==0||!chatContainer.lastChild.classList.contains('user')||chatContainer.lastChild.tagName!='IMG'){
                  await updateScreenshot();
                }
                const [replyimg,replytext,replyop]=await callAPI(questionNow);
                appendMessage("user", questionNow);
                messageInput.value = ""; // 清空輸入框
                messageInput.placeholder=`輸入新的問題，或者直接點擊送出可以沿用上個問題「${questionNow}」`;
                if(replyimg!=null)appendImage("bot", replyimg);
                else appendMessage("bot",`${data['content']['operation']=='done'?'目標完成':'其他操作'}無圖片`);
                appendMessage("bot", replytext);
            }
        }
        sendButton.addEventListener('click',send);

        async function appendMessage(sender, message) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message', sender);
            messageDiv.textContent = message;
            chatContainer.appendChild(messageDiv);

            // 讓捲軸自動滾動到底部
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
        
        async function appendImage(sender, screenshot) {
            const messageDiv = document.createElement('img');
            messageDiv.classList.add('message', sender);
            messageDiv.src = screenshot;
            chatContainer.appendChild(messageDiv);
            messageDiv.addEventListener('click', function() {
                messageDiv.classList.toggle('fullscreen');
            });
            // 讓捲軸自動滾動到底部
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

                // 讓使用者按下enter鍵也能送出訊息
        // messageInput.addEventListener("keyup", function(event) {
        //   if (event.keyCode === 13) {
        //    event.preventDefault();
        //    sendButton.click();
        //   }
        // });
        pipButton.addEventListener('click',startPIP);
        async function startPIP(){
            // Open a Picture-in-Picture window.
            const pipWindow = await documentPictureInPicture.requestWindow({
                width: 250,
                height: 300,
                disallowReturnToOpener: true,
            });

            const style = pipWindow.document.createElement('style');
            style.textContent = `
                body {
                    font-family: sans-serif;
                    margin: 0;
                    display: flex;
                    flex-direction: column;
                    min-height: 100vh;
                    background-color: #f5f5f5;
                    font-size: 16px; /* 設定基本字體大小 */
                }
                #chat-container {
                    width: 90%;
                    max-width: 500px; /* 在較大螢幕上限制最大寬度 */
                    margin: 20px auto;
                    border: solid #ddd;
                    padding: 10px;
                    overflow-y: auto;
                    flex-grow: 1;
                    border-radius: 8px;
                    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
                    background-color: white;
                    padding-bottom: 70px; /* 根據輸入欄的高度調整，略微增加 */
                    box-sizing: border-box;
                }
                #chat-container img {
                    max-width: 90%;
                    height: auto;
                    display: block;
                    margin: 5px auto;
                    object-fit: cover; /* 讓圖片填滿容器，並保持圖片的長寬比 */
                    transition: transform 0s ease; /* 加入過渡效果，使放大縮小更平滑 */
                }
                .message {
                    margin-bottom: 10px;
                    padding: 10px;
                    border-radius: 10px;
                    clear: both;
                    word-wrap: break-word;
                    font-size: 1rem; /* 使用 rem 單位，更容易縮放 */
                    line-height: 1.4; /* 設定行高，增加可讀性 */
                }
                .user {
                    background-color: #dcf8c6;
                    float: right;
                }

                .bot {
                    background-color: #e0f2f7;
                    float: left;
                }
                body {
                    background-color: white;
                    color: black;
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: flex-start;
                    height: 100vh;
                    margin: 0;
                    padding-bottom: 20px;
                }
                #chat-container {
                    width: 100%;
                    height: 200px;
                    overflow-y: auto;
                    border: 1px solid #ddd;
                    padding: 10px;
                    background-color: white;
                    flex-grow: 1;
                }
                button {
                    font-size: 0.8rem;
                    margin: 5px;
                    padding: 8px 12px;
                    border: none;
                    cursor: pointer;
                    border-radius: 5px;
                }
                #send-button, #hideButton {
                    background-color: #4CAF50;
                    color: white;
                }
                #send-button:hover, #hideButton:hover {
                    background-color: #3E8E41;
                    color: white;
                }
                #largeButton {
                    background-color: #c96865;
                    color: white;
                }
                #largeButton:hover {
                    background-color: #A63E3A;
                    color: white;
                }
                #input-area {
                    width: 100%;
                    padding: 10px;
                    background-color: #eee;
                    box-sizing: border-box;
                    position: fixed;
                    bottom: 0;
                    left: 0;
                    display: flex;
                    justify-content: center;
                }
            `;
            pipWindow.document.head.appendChild(style);

            // Create the chat and input areas inside PiP
            pipWindow.document.body.innerHTML += `
                <div id="chat-container"></div>
                <div id="input-area">
                    <div id="sendContainer">
                        <button id="send-button">下一步</button>
                    </div>
                    <div id="hideContainer">
                        <button id="hideButton">隱藏</button>
                    </div>
                    <div id="pipContainer">
                        <button id="largeButton" value = '1'>放大</button>
                    </div>
                </div>
            `;
            pipWindow.document.getElementById('hideButton').value = '1';
            // **Copy Existing Messages from Main Chat to PiP Chat**
            function copyChatMessages() {
                const mainChat = document.getElementById('chat-container');
                const pipChat = pipWindow.document.getElementById('chat-container');
                
                pipChat.innerHTML = mainChat.innerHTML; // Copy messages

                // Attach click event for images to toggle fullscreen in PiP
                pipChat.querySelectorAll('img').forEach(img => {
                    img.addEventListener('click', function() {
                        window.opener.postMessage({ action: 'fullscreen', src: img.src }, '*'); // Send message to main window
                        window.focus();
                    });
                });
            }

            window.addEventListener('message', function (event) {
                if (event.data.action === 'fullscreen') {
                    const mainChatImages = document.querySelectorAll('#chat-container img');
                    mainChatImages.forEach(img => {
                        if (img.src === event.data.src) {
                            img.classList.add('fullscreen'); // Make the matching image fullscreen
                        }
                    });
                }
            });
            copyChatMessages(); // Copy chat messages initially

            
            // **Auto-sync when a new message is added**
            const observer = new MutationObserver(copyChatMessages);
            observer.observe(document.getElementById('chat-container'), { childList: true });

            // Button events
            pipWindow.document.getElementById('largeButton').addEventListener('click', () => {
                pipWindow.close();
                window.focus();
                });

            pipWindow.document.getElementById('hideButton').addEventListener('click', () => {
                const hideButton = pipWindow.document.getElementById('hideButton');
                const chatContainer = pipWindow.document.getElementById('chat-container');
                // window.alert(hideButton.value);
                if (hideButton.value == '1') {
                    if (chatContainer) {
                        chatContainer.style.display = 'none'; // Hide chat container
                    }
                    
                    // Get current window position
                    const screenWidth = window.screen.width;
                    const screenHeight = window.screen.height;
    
                    const pipWidth = 250;
                    const pipHeight = 100;
    
                    // Set new position to keep it at bottom-right
                    pipWindow.resizeTo(pipWidth, pipHeight);
                    pipWindow.moveTo(screenWidth, screenHeight); // Adjust margins
                    // pipWindow.resizeTo(250, 100);
                    hideButton.value = '0';
                    hideButton.innerHTML = `顯示`;
                }
                else {
                    chatContainer.style.display = 'initial';
                    pipWindow.resizeTo(250, 300);
                    pipWindow.moveTo(window.screen.width, window.screen.height);
                    hideButton.value = '1';
                    hideButton.innerHTML = `隱藏`;
                }
            });

            pipWindow.document.getElementById('send-button').addEventListener('click', send);
        };
    </script>

</body>
</html>